#!/bin/sh
#yorkie 2.0.0
echo "ðŸŽ‰ Git Hooks ì‹¤í–‰ ðŸŽ‰"
command_exists () {
  command -v "$1" >/dev/null 2>&1
}
has_hook_script () {
  [ -f package.json ] && cat package.json | grep -q "\"$1\"[[:space:]]*:"
}
load_nvm () {
  command_exists nvm || {
    export NVM_DIR="$1"
    [ -s "$1/nvm.sh" ] && . "$1/nvm.sh"
  }
}
run_nvm () {
  command_exists nvm && [ -f .nvmrc ] && nvm use
}
cd "."
if [ -z "$BRANCHES_TO_SKIP" ]; then
  BRANCHES_TO_SKIP=(master main develop release hotfix)
fi
COMMIT_EDITMSG_FILE_PATH=$1
DEFAULT_COMMIT_MSG=$(cat $COMMIT_EDITMSG_FILE_PATH)
CURRENT_ISSUE=$(git rev-parse --abbrev-ref HEAD)
ISSUE_TICKET=$(echo "$CURRENT_ISSUE" | sed 's/.*\///')
COMMIT_SOURCE=$2
# ì²´ë¦¬í”½ì˜ ê²½ìš° "(cherry picked from commit ...)" ë©”ì‹œì§€ê°€ í¬í•¨ë˜ë¯€ë¡œ ì´ë¥¼ í™•ì¸
if echo "$DEFAULT_COMMIT_MSG" | grep -q "(cherry picked from commit"; then
  exit 0
fi
# mergeì˜ ê²½ìš° í…œí”Œë¦¿ ì¶”ê°€ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤
if [ "$COMMIT_SOURCE" = "merge" ]; then
  exit 0
fi
# ë³‘í•© ì¤‘ì˜ ì»¤ë°‹ì¸ì§€ í™•ì¸
if echo "$DEFAULT_COMMIT_MSG" | grep -qiE "^(merge|ë³‘í•©)"; then
  exit 0
fi
TEMPLATE="# ì£¼ì˜ì‚¬í•­
# [ì œëª©-ë‚´ìš©-ì°¸ì¡°] ì‚¬ì´ì— ë¹ˆ ì¤„ ê°œí–‰ í•„ìˆ˜
# ì œëª©ì˜ prefixì™€ ë‚´ìš© ì‚¬ì´ëŠ” ì½œë¡ (:)ê³¼ ê³µë°±( ) ê¸°ìž… í•„ìˆ˜
# ==============================================
# ì˜ˆ) feat: Aê¸°ëŠ¥ ì¶”ê°€
# ì œëª© (ë°”ë¡œ ì•„ëž˜ì¤„ì— ìž‘ì„± í›„ ê°œí–‰ ìœ ì§€)
# ==============================================
# ì˜ˆ) - ê¸°ëŠ¥1 ì¶”ê°€
# ë‚´ìš© (ë°”ë¡œ ì•„ëž˜ì¤„ì— ìž‘ì„± í›„ ê°œí–‰ ìœ ì§€)
# ==============================================
# ì˜ˆ) refs: ISSUE-9999
# ì°¸ì¡° (ìžë™ ìž‘ì„±)
refs: ISSUE
# ==============================================
# =============== ì»¤ë°‹ ìœ í˜• ====================
# feat       | ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€
# fix        | ë²„ê·¸ ìˆ˜ì •
# !hotfix    | ê¸´ê¸‰ ë²„ê·¸ ìˆ˜ì •
# design     | UI ë””ìžì¸ ìˆ˜ì •
# style      | ì½”ë“œ í¬ë§·íŒ…ê°™ì€ ì½”ë“œì˜ ë¡œì§ ìˆ˜ì •ì´ ì—†ëŠ” ê²½ìš°
# refactor   | ì½”ë“œ ë¦¬íŒ©í† ë§
# comment    | í•„ìš”í•œ ì£¼ì„ ì¶”ê°€ ë° ë³€ê²½
# test       | í…ŒìŠ¤íŠ¸ ì½”ë“œ
# docs       | ë¬¸ì„œ ìˆ˜ì •
# rename     | íŒŒì¼/í´ë”ëª…ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ê²½ë¡œì´ë™ ìž‘ì—…ë§Œ í•œ ê²½ìš°
# remove     | íŒŒì¼ì„ ì‚­ì œí•˜ëŠ” ìž‘ì—…ë§Œ í•œ ê²½ìš°
# chore      | ë¹Œë“œ/íŒ¨í‚¤ì§€ ê´€ë ¨ ìˆ˜ì •
# ci         | CI ì„¤ì • íŒŒì¼ ìˆ˜ì •
# build      | ë¹Œë“œ íŒŒì¼ ìˆ˜ì •
# pref       | ì„±ëŠ¥ ê°œì„ 
# =============================================="
FINAL_TEMPLATE=$(echo "$TEMPLATE" | sed "s/ISSUE/$ISSUE_TICKET/g")
echo -e "$FINAL_TEMPLATE\n$DEFAULT_COMMIT_MSG" > $COMMIT_EDITMSG_FILE_PATH
has_hook_script prepare-commit-msg || exit 0
export PATH="$PATH:/c/Program Files/nodejs"
export GIT_PARAMS="$*"
node "./node_modules/yorkie/src/runner.js" prepare-commit-msg || {
  echo
  echo "prepare-commit-msg hook failed (cannot be bypassed with --no-verify due to Git specs)"
  exit 1
}